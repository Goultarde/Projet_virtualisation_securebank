Vagrant.configure("2") do |config|
  # Utiliser Ubuntu 20.04 LTS plus stable
  config.vm.box = "ubuntu/focal64"
  
  # VM pour SecureBank
  config.vm.define "securebank-web" do |web|
    web.vm.network "private_network", ip: "192.168.56.40"
    web.vm.network "forwarded_port", guest: 1337, host: 1337
    web.vm.network "forwarded_port", guest: 80, host: 8080
    web.vm.network "forwarded_port", guest: 443, host: 8443

    web.vm.synced_folder "../ansible", "/home/vagrant/ansible"

    web.vm.provision "shell", inline: <<-SHELL
      # Configuration réseau robuste
      echo "nameserver 8.8.8.8" > /etc/resolv.conf
      echo "nameserver 1.1.1.1" >> /etc/resolv.conf
      
      # Attendre la connectivité
      for i in {1..30}; do
        if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done
      
      # Mise à jour avec retry
      for i in {1..3}; do
        apt-get update && break
        sleep 10
      done
      
      # Installer Ansible et dépendances
      DEBIAN_FRONTEND=noninteractive apt-get install -y ansible python3 python3-pip curl wget jq
      
      # Exécuter le playbook
      cd /home/vagrant/ansible
      ansible-playbook -i localhost, -c local main.yml
    SHELL
  end

  # VM pour la PKI CFSSL
  config.vm.define "pki-server" do |pki|
    pki.vm.network "private_network", ip: "192.168.56.41"
    pki.vm.network "forwarded_port", guest: 8888, host: 8888  # API CFSSL

    pki.vm.synced_folder "../ansible", "/home/vagrant/ansible"

    pki.vm.provision "shell", inline: <<-SHELL
      # Configuration réseau robuste
      echo "nameserver 8.8.8.8" > /etc/resolv.conf
      echo "nameserver 1.1.1.1" >> /etc/resolv.conf
      
      # Attendre la connectivité
      for i in {1..30}; do
        if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done
      
      # Mise à jour avec retry
      for i in {1..3}; do
        apt-get update && break
        sleep 10
      done
      
      # Installer Ansible et dépendances
      DEBIAN_FRONTEND=noninteractive apt-get install -y ansible python3 python3-pip curl wget jq nginx
      
      # Exécuter le playbook
      cd /home/vagrant/ansible
      ansible-playbook -i localhost, -c local pki_main.yml
    SHELL
  end
end
